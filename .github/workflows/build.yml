name: Build

on:
  workflow_dispatch: {}

jobs:
  build:
    name: Build
    runs-on: ubuntu-22.04
    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 4096
          temp-reserve-mb: 2048
          swap-size-mb: 16384
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up apt and install deps
        run: |
          sudo apt-get update
          APT_OPTS="-o APT::Install-Recommends=false -o APT::Install-Suggests=false"
          sudo apt-get $APT_OPTS -y install \
            build-essential autoconf2.13 python3 python3-dev python3-pip \
            curl wget git mercurial zip unzip pkg-config \
            libssl-dev libdbus-1-dev libasound2-dev libglib2.0-dev \
            libgtk-3-dev libx11-dev libxcomposite-dev libxrandr-dev \
            libxrender-dev libxss-dev libxinerama-dev libxt-dev libxcb1-dev \
            libdrm-dev libpulse-dev libsqlite3-dev libexpat1-dev libffi-dev \
            zlib1g-dev libbz2-dev liblzma-dev libzip-dev libpng-dev libjpeg-dev \
            libfreetype6-dev pkg-config automake libtool nasm ccache \
            python3-venv libgnutls28-dev libnss3-dev ninja-build clang lld \
            pigz gnupg jq rsync xz-utils
      - name: Run sccache-cache (install)
        uses: mozilla-actions/sccache-action@v0.0.9
        with:
          version: "v0.12.0"

      - name: Configure sccache environment
        run: |
          echo "SCCACHE_GHA_ENABLED=true" >> "$GITHUB_ENV"
          echo "RUSTC_WRAPPER=sccache" >> "$GITHUB_ENV"
          echo "CMAKE_C_COMPILER_LAUNCHER=sccache" >> "$GITHUB_ENV"
          echo "CMAKE_CXX_COMPILER_LAUNCHER=sccache" >> "$GITHUB_ENV"
          echo "CC=sccache clang" >> "$GITHUB_ENV"
          echo "CXX=sccache clang++" >> "$GITHUB_ENV"
          echo "SCCACHE_IDLE_TIMEOUT=0" >> "$GITHUB_ENV"
        shell: bash

      - name: Run build (fetch, patch-check, bsys6 test-linux, copy artifact)
        run: |
          set -euo pipefail
          git clone --branch main --single-branch --recursive https://codeberg.org/librewolf/source.git librewolf-source
          cd librewolf-source

          echo "0" > release
          echo "146.0b9" > version
          
          echo "mk_add_options MOZ_PARALLEL_BUILD=3" >> assets/mozconfig.new
          echo "===== assets/mozconfig.new ====="
          sed -n '1,200p' assets/mozconfig.new || true
          echo "===== end mozconfig.new ====="
          make fetch
          sh -c "./scripts/check-patchfail.sh"
          make test-linux
          ARTIFACT=$(find . -type f -name 'librewolf-*-linux-*-package.tar.xz' -print -quit)
          if [ -n "$ARTIFACT" ]; then
            echo "Found artifact: $ARTIFACT"
            cp -v "$ARTIFACT" "$GITHUB_WORKSPACE/librewolf-linux.tar.xz"
          else
            echo "No .tar.xz found from test-linux"
            exit 1
          fi
      - name: sccache show-stats
        run: ${SCCACHE_PATH:-sccache} --show-stats || true

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: librewolf-build
          path: |
            librewolf-linux.tar.xz
