name: Build

on:
  workflow_dispatch: {}

jobs:
  build:
    name: Build
    runs-on: ubuntu-22.04
    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 4096
          temp-reserve-mb: 2048
          swap-size-mb: 16384
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up apt and install deps
        run: |
          sudo apt-get update
          APT_OPTS="-o APT::Install-Recommends=false -o APT::Install-Suggests=false"
          sudo apt-get $APT_OPTS -y install \
            build-essential autoconf2.13 python3 python3-dev python3-pip \
            curl wget git mercurial zip unzip pkg-config \
            libssl-dev libdbus-1-dev libasound2-dev libglib2.0-dev \
            libgtk-3-dev libx11-dev libxcomposite-dev libxrandr-dev \
            libxrender-dev libxss-dev libxinerama-dev libxt-dev libxcb1-dev \
            libdrm-dev libpulse-dev libsqlite3-dev libexpat1-dev libffi-dev \
            zlib1g-dev libbz2-dev liblzma-dev libzip-dev libpng-dev libjpeg-dev \
            libfreetype6-dev pkg-config automake libtool nasm ccache \
            python3-venv libgnutls28-dev libnss3-dev ninja-build clang lld \
            pigz gnupg jq rsync xz-utils

      - name: Run sccache-cache (install)
        uses: mozilla-actions/sccache-action@v0.0.9
        with:
          version: "v0.12.0"

      - name: Configure sccache environment
        run: |
          echo "SCCACHE_GHA_ENABLED=true" >> $GITHUB_ENV
          echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
          echo "CMAKE_C_COMPILER_LAUNCHER=sccache" >> $GITHUB_ENV
          echo "CMAKE_CXX_COMPILER_LAUNCHER=sccache" >> $GITHUB_ENV
        shell: bash

      - name: Enable sccache for C/C++
        run: |
          set -euxo pipefail
          SCCACHE_BIN="${SCCACHE_PATH:-$(which sccache)}"
          REAL_CC="$(which cc || which clang || which gcc || echo /usr/bin/cc)"
          REAL_CXX="$(which c++ || which clang++ || which g++ || echo /usr/bin/c++)"
          echo "Using SCCACHE_BIN=$SCCACHE_BIN"
          echo "Using REAL_CC=$REAL_CC"
          echo "Using REAL_CXX=$REAL_CXX"

          mkdir -p "$HOME/ccwrap/bin"

          cat > "$HOME/ccwrap/bin/cc" <<'EOF'
          #!/usr/bin/env bash
          exec "'"$SCCACHE_BIN"'" "'"$REAL_CC"'" "$@"
          EOF

          cat > "$HOME/ccwrap/bin/c++" <<'EOF'
          #!/usr/bin/env bash
          exec "'"$SCCACHE_BIN"'" "'"$REAL_CXX"'" "$@"
          EOF

          chmod +x "$HOME/ccwrap/bin/cc" "$HOME/ccwrap/bin/c++"

          echo "PATH=$HOME/ccwrap/bin:$PATH" >> $GITHUB_ENV
          echo "CC=$HOME/ccwrap/bin/cc" >> $GITHUB_ENV
          echo "CXX=$HOME/ccwrap/bin/c++" >> $GITHUB_ENV
          echo "SCCACHE_COMPILER=$REAL_CC" >> $GITHUB_ENV
          echo "RUSTC_WRAPPER=$SCCACHE_BIN" >> $GITHUB_ENV
          echo "CMAKE_C_COMPILER_LAUNCHER=$SCCACHE_BIN" >> $GITHUB_ENV
          echo "CMAKE_CXX_COMPILER_LAUNCHER=$SCCACHE_BIN" >> $GITHUB_ENV

          echo "PATH=$PATH"
          which cc || true
          which c++ || true
          $SCCACHE_BIN --version || true
        shell: bash

      - name: Run build (fetch, patch-check, bsys6 test-linux, copy artifact)
        env:
          SCCACHE_PATH: ${{ env.SCCACHE_PATH }}
        run: |
          set -euo pipefail
          git clone --recursive https://gitlab.com/librewolf-community/browser/source.git librewolf-source
          cd librewolf-source

          echo "mk_add_options MOZ_PARALLEL_BUILD=3" >> assets/mozconfig.new

          echo "===== assets/mozconfig.new ====="
          sed -n '1,200p' assets/mozconfig.new || true
          echo "===== end mozconfig.new ====="

          make fetch

          sh -c "./scripts/check-patchfail.sh"

          make test-linux

          ARTIFACT=$(find . -type f -name '*.tar.xz' -print | head -n 1 || true)
          if [ -n "$ARTIFACT" ]; then
            echo "Found artifact: $ARTIFACT"
            cp -v "$ARTIFACT" "$GITHUB_WORKSPACE/librewolf-linux.tar.xz"
          else
            echo "No .tar.xz found from test-linux"
            exit 1
          fi
      - name: sccache show-stats
        run: ${SCCACHE_PATH:-sccache} --show-stats || true

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: librewolf-build
          path: |
            librewolf-linux.tar.xz
